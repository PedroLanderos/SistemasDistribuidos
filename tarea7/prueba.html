<!DOCTYPE html>
<html>
<head>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
          charset="utf-8">
    <meta name="author" content="Carlos Pineda Guerrero. 2025">

    <!-- OJO: ruta relativa, sin "/" al inicio -->
    <script src="WSClient.js"></script>

    <script>
        // Tu backend REST
        var URL = "/Servicio/rest/ws";
        var email;
        var token;

        var foto = null;  // por default la foto es nula

        function get(id) {
            return document.getElementById(id);
        }

        function muestra(id) {
            get(id).style.display = "block";
        }

        function oculta(id) {
            get(id).style.display = "none";
        }

        function readSingleFile(files, imagen) {
            var file = files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function (e) {
                imagen.src = reader.result;
                // reader.result incluye al principio: "data:image/jpeg;base64,"
                foto = reader.result.split(',')[1];
            };
            reader.readAsDataURL(file);
        }

        async function sha256(texto) {
            var encoder = new TextEncoder();
            var datos = encoder.encode(texto);
            var hashBuffer = await crypto.subtle.digest('SHA-256', datos);
            var hashArray = Array.from(new Uint8Array(hashBuffer));
            var hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        function limpia_login() {
            get("login_email").value = "";
            get("login_password").value = "";
        }

        function limpia_alta() {
            get("alta_email").value = "";
            get("alta_password").value = "";
            get("alta_nombre").value = "";
            get("alta_apellido_paterno").value = "";
            get("alta_apellido_materno").value = "";
            get("alta_fecha_nacimiento").value = "";
            get("alta_telefono").value = "";
            get("alta_genero").value = "";
            get("alta_imagen").src = "usuario_sin_foto.png";
            foto = null;
        }

        function login() {
            var cliente = new WSClient(URL);

            cliente.get("login",
                {
                    email: get("login_email").value,
                    password: get("login_password").value
                },
                function (code, result) {
                    if (code == 200) {
                        email = get("login_email").value;
                        token = result.token;
                        oculta("login");
                        muestra("menu");
                    } else
                        alert(JSON.stringify(result));
                });
        }

        function alta() {
            var cliente = new WSClient(URL);

            var usuario =
            {
                email: get("alta_email").value,
                password: get("alta_password").value,
                nombre: get("alta_nombre").value,
                apellido_paterno: get("alta_apellido_paterno").value,
                apellido_materno: get("alta_apellido_materno").value != "" ? get("alta_apellido_materno").value : null,
                fecha_nacimiento: get("alta_fecha_nacimiento").value != "" ?
                    new Date(get("alta_fecha_nacimiento").value).toISOString() : null,
                telefono: get("alta_telefono").value != "" ? get("alta_telefono").value : null,
                genero: get("alta_genero").value == "Masculino" ? "M" :
                        get("alta_genero").value == "Femenino" ? "F" : null,
                foto: foto
            };

            cliente.post("alta_usuario",
                usuario,
                function (code, result) {
                    if (code == 200) {
                        alert("Se registró el usuario");
                        limpia_login();
                        oculta('alta_usuario');
                        muestra('login');
                    } else
                        alert(JSON.stringify(result));
                });
        }

        function limpia_consulta() {
            get("consulta_email").value = "";
            get("consulta_password").value = "";
            get("consulta_nombre").value = "";
            get("consulta_apellido_paterno").value = "";
            get("consulta_apellido_materno").value = "";
            get("consulta_fecha_nacimiento").value = "";
            get("consulta_telefono").value = "";
            get("consulta_genero").value = "";
            get("consulta_imagen").src = "usuario_sin_foto.png";
        }

        function quita_foto() {
            foto = null;
            get('consulta_imagen').src = 'usuario_sin_foto.png';
            get('consulta_file').value = '';
        }

        function formatearFecha(fecha) {
            var f = new Date(fecha);
            var año = f.getFullYear();
            var mes = (f.getMonth() + 1).toString().padStart(2, '0');
            var dia = f.getDate().toString().padStart(2, '0');
            var horas = f.getHours().toString().padStart(2, '0');
            var minutos = f.getMinutes().toString().padStart(2, '0');
            var segundos = f.getSeconds().toString().padStart(2, '0');
            return año + "-" + mes + "-" + dia + "T" + horas + ":" + minutos + ":" + segundos;
        }

        function consulta() {
            var cliente = new WSClient(URL);
            cliente.get("consulta_usuario",
                {
                    email: email,
                    token: token
                },
                function (code, result) {
                    if (code == 200) {
                        limpia_consulta();
                        oculta('menu');
                        muestra('consulta_usuario');
                        get("consulta_email").value = result.email;
                        get("consulta_password").value = "";
                        get("consulta_nombre").value = result.nombre;
                        get("consulta_apellido_paterno").value = result.apellido_paterno;
                        get("consulta_apellido_materno").value =
                            result.apellido_materno != null ? result.apellido_materno : "";
                        if (result.fecha_nacimiento)
                            get("consulta_fecha_nacimiento").value =
                                formatearFecha(new Date(result.fecha_nacimiento));
                        get("consulta_telefono").value =
                            result.telefono != null ? result.telefono : "";
                        get("consulta_genero").value =
                            result.genero == "M" ? "Masculino" :
                            result.genero == "F" ? "Femenino" : "";
                        foto = result.foto;
                        get("consulta_imagen").src =
                            foto != null ? "data:image/jpeg;base64," + foto : "usuario_sin_foto.png";
                    }
                    else
                        alert(JSON.stringify(result));
                });
        }

        function modifica() {
            var cliente = new WSClient(URL);

            var usuario =
            {
                password: get("consulta_password").value,
                nombre: get("consulta_nombre").value,
                apellido_paterno: get("consulta_apellido_paterno").value,
                apellido_materno: get("consulta_apellido_materno").value != "" ? get("consulta_apellido_materno").value : null,
                fecha_nacimiento: get("consulta_fecha_nacimiento").value != "" ?
                    new Date(get("consulta_fecha_nacimiento").value).toISOString() : null,
                telefono: get("consulta_telefono").value != "" ? get("consulta_telefono").value : null,
                genero: get("consulta_genero").value == "Masculino" ? "M" :
                        get("consulta_genero").value == "Femenino" ? "F" : null,
                foto: foto
            };

            cliente.put("modifica_usuario",
                {
                    email: get("consulta_email").value,
                    token: token
                },
                usuario,
                function (code, result) {
                    if (code == 200)
                        alert("Se modificó el perfil del usuario");
                    else
                        alert(JSON.stringify(result));
                });
        }

        function borra() {
            var client = new WSClient(URL);
            client.delete("borra_usuario",
                {
                    email: email,
                    token: token
                },
                function (code, result) {
                    if (code == 200) {
                        alert("Se eliminó el perfil del usuario");
                        limpia_login();
                        oculta('menu');
                        muestra('login');
                    } else
                        alert(JSON.stringify(result));
                });
        }
    </script>
</head>
<body>
<div style="width:250px;margin:auto">

    <div id="alta_usuario" style="display:none">
        <h2 style="text-align:center">Registro de usuario</h2>
        Email *<br>
        <input type="email" id="alta_email" value="" style="width:250px"/><br>
        Contraseña *<br>
        <input type="password" id="alta_password" value="" style="width:250px"/><br>
        Nombre *<br>
        <input type="text" id="alta_nombre" value="" style="width:250px"/><br>
        Apellido paterno *<br>
        <input type="text" id="alta_apellido_paterno" value="" style="width:250px"/><br>
        Apellido materno<br>
        <input type="text" id="alta_apellido_materno" value="" style="width:250px"/><br>
        Fecha de nacimiento *<br>
        <input type="datetime-local" id="alta_fecha_nacimiento" value="" style="width:250px"/><br>
        Teléfono<br>
        <input type="number" id="alta_telefono" value="" style="width:250px"/><br>
        Genero<br>
        <select id="alta_genero" style="width:250px">
            <option></option>
            <option>Masculino</option>
            <option>Femenino</option>
        </select>
        <br><br>
        <img id="alta_imagen" width="60px" src="usuario_sin_foto.png"></img><br>
        <input type="file" onchange="readSingleFile(files,get('alta_imagen'))" multiple="false" accept="image/*"/><br>
        <br>
        <button type="button" onclick="alta();" style="width:250px;height:40px">Registrar usuario</button><br><br>
        <button type="button"
                onclick="limpia_login();oculta('alta_usuario');muestra('login')"
                style="width:250px;height:40px">Cancelar</button><br>
    </div>

    <div id="consulta_usuario" style="display:none">
        <h2 style="text-align:center">Perfil del usuario</h2>
        Email *<br>
        <input type="email" readonly id="consulta_email" style="width:250px"/><br>
        Contraseña *<br>
        <input type="password" id="consulta_password" value="" style="width:250px"/><br>
        Nombre *<br>
        <input type="text" id="consulta_nombre" value="" style="width:250px"/><br>
        Apellido paterno *<br>
        <input type="text" id="consulta_apellido_paterno" value="" style="width:250px"/><br>
        Apellido materno<br>
        <input type="text" id="consulta_apellido_materno" value="" style="width:250px"/><br>
        Fecha de nacimiento *<br>
        <input type="datetime-local" id="consulta_fecha_nacimiento" value="" style="width:250px"/><br>
        Teléfono<br>
        <input type="number" id="consulta_telefono" value="" style="width:250px"/><br>
        Genero<br>
        <select id="consulta_genero" style="width:250px">
            <option></option>
            <option>Masculino</option>
            <option>Femenino</option>
        </select>
        <br><br>
        <img id="consulta_imagen" width="60px" src="usuario_sin_foto.png"></img>
        <input type="file" id="consulta_file" onchange="readSingleFile(files,get('consulta_imagen'))"
               multiple="false" accept="image/*"/><br>
        <button onclick="quita_foto()">Quitar foto</button><br><br>
        <button type="button" onclick="modifica()" style="width:250px;height:40px">Guardar cambios</button><br><br>
        <button type="button" onclick="oculta('consulta_usuario');muestra('menu')"
                style="width:250px;height:40px">Regresar</button><br>
    </div>

    <div id="menu" style="display:none">
        <button type="button" onclick="consulta();" style="width:250px;height:40px">
            Perfil del usuario
        </button><br><br>
        <button type="button"
                onclick="if (confirm('¿Deseas eliminar el perfil del usuario?')){borra();}"
                style="width:250px;height:40px">
            Eliminar perfil
        </button><br><br>
        <button type="button"
                onclick="limpia_login();oculta('menu');muestra('login')"
                style="width:250px;height:40px">
            Salir
        </button><br>
    </div>

    <div id="login">
        <h2 style="text-align:center">Acceso al sistema</h2>
        Email<br>
        <input type="email" id="login_email" value="" style="width:250px"/><br><br>
        Password<br>
        <input type="password" id="login_password" value="" style="width:250px"/><br><br>
        <button type="button" onclick="login()" style="width:250px;height:40px">Aceptar</button><br><br>
        <button type="button"
                onclick="limpia_alta();oculta('login');muestra('alta_usuario')"
                style="width:250px;height:40px">
            Registro de usuario
        </button><br><br>
    </div>
</div>
</body>
</html>
