<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" charset="utf-8">
		<meta name="author" content="Carlos Pineda Guerrero. 2025">
		<script src='/api/Get?nombre=/WSClient.js'></script>
		<script>
			var URL = "/api";
			var email;
			var token;
			var id_usuario; // <<< NUEVO: id del usuario autenticado

			// Foto del usuario
			var foto = null;
			// Foto del artículo
			var foto_articulo = null;

			function get(id)
			{
				return document.getElementById(id);
			}
			function muestra(id)
			{
				get(id).style.display = "block";
			}
			function oculta(id)
			{
				get(id).style.display = "none";
			}

			// ========== LECTURA DE ARCHIVOS (USUARIO) ==========
			function readSingleFile(files,imagen)
			{
				var file = files[0];
				if (!file) return;
				var reader = new FileReader();
				reader.onload = function(e)
				{
					imagen.src = reader.result;
					// reader.result incluye al principio: "data:image/jpeg;base64,"
					foto = reader.result.split(',')[1];
				};
				reader.readAsDataURL(file);
			}

			// ========== LECTURA DE ARCHIVOS (ARTÍCULO) ==========
			function readSingleFileArticulo(files,imagen)
			{
				var file = files[0];
				if (!file) return;
				var reader = new FileReader();
				reader.onload = function(e)
				{
					imagen.src = reader.result;
					foto_articulo = reader.result.split(',')[1];
				};
				reader.readAsDataURL(file);
			}

			// ========== SHA-256 ==========
			async function sha256(texto)
			{
				var encoder = new TextEncoder();
				var datos = encoder.encode(texto);
				var hashBuffer = await crypto.subtle.digest('SHA-256', datos);
				var hashArray = Array.from(new Uint8Array(hashBuffer));
				var hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
				return hashHex;
			}

			// ========== LOGIN / ALTA USUARIO ==========
			function limpia_login()
			{
				get("login_email").value = "";
				get("login_password").value = "";
			}
			function limpia_alta()
			{
				get("alta_email").value = "";
				get("alta_password").value = "";
				get("alta_nombre").value = "";
				get("alta_apellido_paterno").value = "";
				get("alta_apellido_materno").value = "";
				get("alta_fecha_nacimiento").value = "";
				get("alta_telefono").value = "";
				get("alta_genero").value = "";
				get("alta_imagen").src = "/api/Get?nombre=/usuario_sin_foto.png";
				foto = null;
			}

			function login()
			{
				var cliente = new WSClient(URL);
				sha256(get("login_password").value).then(hash =>
				{
					cliente.get("login",
					{
						email: get("login_email").value,
						password: hash
					},
					function(code,result)
					{
						if (code == 200)
						{
							email = get("login_email").value;
							token = result.token;

							// <<< NUEVO: obtener id_usuario justo después del login
							var cliente2 = new WSClient(URL);
							cliente2.get("consulta_usuario",
							{
								email: email,
								token: token
							},
							function(code2,res2)
							{
								if (code2 == 200)
								{
									// WSClient ya debe devolver un objeto JSON
									id_usuario = res2.id_usuario;
								}
								else
								{
									alert("No se pudo obtener id_usuario: " + JSON.stringify(res2));
								}
							});

							oculta("login");
							muestra("menu");
						}
						else
							alert(JSON.stringify(result));
					});
				});
			}

			function alta()
			{
				var cliente = new WSClient(URL);
				sha256(get("alta_password").value).then(hash =>
				{
					var usuario =
					{
						email: get("alta_email").value,
						password: hash,
						nombre: get("alta_nombre").value,
						apellido_paterno: get("alta_apellido_paterno").value,
						apellido_materno: get("alta_apellido_materno").value != "" ? get("alta_apellido_materno").value : null,
						fecha_nacimiento: get("alta_fecha_nacimiento").value != "" ? new Date(get("alta_fecha_nacimiento").value).toISOString() : null,
						telefono: get("alta_telefono").value != "" ? get("alta_telefono").value : null,
						genero: get("alta_genero").value == "Masculino" ? "M" : get("alta_genero").value == "Femenino" ? "F" : null,
						foto: foto
					};
					cliente.post("alta_usuario",
					usuario,
					function(code,result)
					{
						if (code == 200)
						{
							alert("Se registró el usuario");
							limpia_login();
							oculta('alta_usuario');
							muestra('login');
						}
						else
							alert(JSON.stringify(result));
					});
				});
			}

			// ========== CONSULTA / MODIFICA / BORRA USUARIO ==========
			function limpia_consulta()
			{
				get("consulta_email").value = "";
				get("consulta_password").value = "";
				get("consulta_nombre").value = "";
				get("consulta_apellido_paterno").value = "";
				get("consulta_apellido_materno").value = "";
				get("consulta_fecha_nacimiento").value = "";
				get("consulta_telefono").value = "";
				get("consulta_genero").value = "";
				get("consulta_imagen").src = "/api/Get?nombre=/usuario_sin_foto.png";
			}
			function quita_foto()
			{
				foto = null;
				get("consulta_imagen").src = "/api/Get?nombre=/usuario_sin_foto.png";
				get('consulta_file').value='';
			}
			function formatearFecha(fecha)
			{
				var fecha = new Date(fecha);
				var año = fecha.getFullYear();
				var mes = (fecha.getMonth() + 1).toString().padStart(2,'0');
				var dia = fecha.getDate().toString().padStart(2,'0');
				var horas = fecha.getHours().toString().padStart(2,'0');
				var minutos = fecha.getMinutes().toString().padStart(2,'0');
				var segundos = fecha.getSeconds().toString().padStart(2,'0');
				return año + "-" + mes + "-" + dia + "T" + horas + ":" + minutos + ":" + segundos;
			}
			function consulta()
			{
				var cliente = new WSClient(URL);
				cliente.get("consulta_usuario",
				{
					email: email,
					token: token
				},
				function(code,result)
				{
					if (code == 200)
					{
						// <<< NUEVO: de aquí también podemos actualizar id_usuario
						id_usuario = result.id_usuario;

						limpia_consulta();
						oculta('menu');
						muestra('consulta_usuario');
						get("consulta_email").value = result.email;
						get("consulta_password").value = "";
						get("consulta_nombre").value = result.nombre;
						get("consulta_apellido_paterno").value = result.apellido_paterno;
						get("consulta_apellido_materno").value = result.apellido_materno != null ? result.apellido_materno : "";
						get("consulta_fecha_nacimiento").value = formatearFecha(new Date(result.fecha_nacimiento+"Z").toLocaleString('en-US'));
						get("consulta_telefono").value = result.telefono != null ? result.telefono : "";
						get("consulta_genero").value = result.genero == "M" ? "Masculino" : result.genero == "F" ? "Femenino" : "";
						foto = result.foto;
						get("consulta_imagen").src = foto != null ? "data:image/jpeg;base64," + foto : "/api/Get?nombre=/usuario_sin_foto.png";
					}
					else
						alert(JSON.stringify(result));
				});
			}
			function modifica_usuario(password)
			{
				var cliente = new WSClient(URL);
				var usuario =
				{
					password: password,
					nombre: get("consulta_nombre").value,
					apellido_paterno: get("consulta_apellido_paterno").value,
					apellido_materno: get("consulta_apellido_materno").value != "" ? get("consulta_apellido_materno").value : null,
					fecha_nacimiento: get("consulta_fecha_nacimiento").value != "" ? new Date(get("consulta_fecha_nacimiento").value).toISOString() : null,
					telefono: get("consulta_telefono").value != "" ? get("consulta_telefono").value : null,
					genero: get("consulta_genero").value == "Masculino" ? "M" : get("consulta_genero").value == "Femenino" ? "F" : null,
					foto: foto
				};
				cliente.put("modifica_usuario",
				{
					email: get("consulta_email").value,
					token: token
				},
				usuario,
				function(code,result)
				{
					if (code == 200)
						alert("Se modificó el perfil del usuario");
					else
						alert(JSON.stringify(result));
				});
			}
			function modifica()
			{
				if (get("consulta_password").value != "")
					sha256(get("consulta_password").value).then(hash =>
					{
						modifica_usuario(hash);
					});
				else
					modifica_usuario("");
			}
			function borra()
			{
				var client = new WSClient(URL);
				client.delete("borra_usuario",
				{
					email: email,
					token: token
				},
				function(code,result)
				{
					if (code == 200)
					{
						alert("Se eliminó el perfil del usuario");
						limpia_login();
						oculta('menu');
						muestra('login');
					}
					else
						alert(JSON.stringify(result));
				});
			}

			// =========================================
			//     NUEVO: CAPTURA DE ARTÍCULO
			// =========================================
			function limpia_captura_articulo()
			{
				get("altaart_nombre").value = "";
				get("altaart_descripcion").value = "";
				get("altaart_precio").value = "";
				get("altaart_existencia").value = "";
				get("altaart_imagen").src = "/api/Get?nombre=/articulo_sin_foto.png";
				foto_articulo = null;
				get("altaart_file").value = "";
			}

			function muestra_captura_articulo()
			{
				limpia_captura_articulo();
				oculta('menu');
				muestra('captura_articulo');
			}

			function guardar_articulo()
			{
				var nombre = get("altaart_nombre").value;
				var descripcion = get("altaart_descripcion").value;
				var precio = get("altaart_precio").value;
				var existencia = get("altaart_existencia").value;

				if (nombre == "" || descripcion == "" || precio == "" || existencia == "")
				{
					alert("Todos los campos marcados son obligatorios");
					return;
				}
				if (!id_usuario)
				{
					alert("No se ha identificado al usuario (id_usuario nulo). Vuelve a iniciar sesión.");
					return;
				}

				var cliente = new WSClient(URL);

				// IMPORTANTE: seguir la misma estructura que tu colección de Postman
				var articulo =
				{
					id_usuario: id_usuario,
					token: token,
					nombre: nombre,
					descripcion: descripcion,
					precio: parseFloat(precio),
					cantidad: parseInt(existencia),
					foto: foto_articulo // si el back la ignora, no pasa nada
				};

				cliente.post("alta_articulo",
				articulo,
				function(code,result)
				{
					if (code == 200)
					{
						alert("Se dio de alta el artículo");
						limpia_captura_articulo();
					}
					else
					{
						alert(JSON.stringify(result));
					}
				});
			}

			// =========================================
			//     NUEVO: COMPRA DE ARTÍCULOS
			// =========================================
			function muestra_compra_articulos()
			{
				get("palabra_clave").value = "";
				get("lista_articulos").innerHTML = "";
				oculta('menu');
				muestra('compra_articulos');
			}

			function buscar_articulos()
			{
				if (!id_usuario)
				{
					alert("No se ha identificado al usuario (id_usuario nulo). Vuelve a iniciar sesión.");
					return;
				}

				var cliente = new WSClient(URL);
				var palabra = get("palabra_clave").value;

				// Usar nombres de parámetros como en la colección:
				// palabra, id_usuario, token
				cliente.get("consulta_articulos",
				{
					palabra: palabra,
					id_usuario: id_usuario,
					token: token
				},
				function(code,result)
				{
					if (code == 200)
					{
						renderizar_articulos(result);
					}
					else
					{
						alert(JSON.stringify(result));
					}
				});
			}

			function renderizar_articulos(lista)
			{
				var cont = get("lista_articulos");
				cont.innerHTML = "";
				if (!lista || lista.length == 0)
				{
					cont.innerHTML = "<p>No se encontraron artículos</p>";
					return;
				}
				for (var i=0;i<lista.length;i++)
				{
					var art = lista[i];
					var div = document.createElement("div");
					div.style.border = "1px solid black";
					div.style.marginBottom = "10px";
					div.style.padding = "5px";

					var imgSrc = art.foto != null ? ("data:image/jpeg;base64," + art.foto) : "/api/Get?nombre=/articulo_sin_foto.png";

					div.innerHTML =
						"<img src='" + imgSrc + "' width='60'><br>" +
						"<b>" + art.nombre + "</b><br>" +
						art.descripcion + "<br>" +
						"Precio: $" + art.precio + "<br>" +
						"Cantidad: <input type='number' min='1' value='1' id='cant_art_" + art.id_articulo + "' style='width:60px'/>" +
						"<br><button type='button' style='width:100%;margin-top:5px' onclick='agregar_al_carrito(" + art.id_articulo + ")'>Compra</button>";

					cont.appendChild(div);
				}
			}

			function agregar_al_carrito(id_articulo)
			{
				if (!id_usuario)
				{
					alert("No se ha identificado al usuario (id_usuario nulo). Vuelve a iniciar sesión.");
					return;
				}
				var cantidad = parseInt(get("cant_art_" + id_articulo).value);
				if (isNaN(cantidad) || cantidad <= 0)
				{
					alert("La cantidad debe ser mayor que cero");
					return;
				}
				var cliente = new WSClient(URL);

				// Igual que en tu colección:
				// { "id_usuario", "token", "id_articulo", "cantidad" }
				var compra =
				{
					id_usuario: id_usuario,
					token: token,
					id_articulo: id_articulo,
					cantidad: cantidad
				};
				cliente.post("compra_articulo",
				compra,
				function(code,result)
				{
					if (code == 200)
						alert("Se agregó el artículo al carrito");
					else
						alert(JSON.stringify(result));
				});
			}

			// =========================================
			//     NUEVO: CARRITO DE COMPRA
			// =========================================
			function mostrar_carrito()
			{
				if (!id_usuario)
				{
					alert("No se ha identificado al usuario (id_usuario nulo). Vuelve a iniciar sesión.");
					return;
				}
				var cliente = new WSClient(URL);
				cliente.get("consulta_carrito_compra",
				{
					id_usuario: id_usuario,
					token: token
				},
				function(code,result)
				{
					if (code == 200)
					{
						oculta('menu');
						oculta('compra_articulos');
						muestra('carrito_compra');
						renderizar_carrito(result);
					}
					else
						alert(JSON.stringify(result));
				});
			}

			function renderizar_carrito(lista)
			{
				var cont = get("lista_carrito");
				cont.innerHTML = "";
				var total = 0.0;

				if (!lista || lista.length == 0)
				{
					cont.innerHTML = "<p>El carrito está vacío</p>";
					get("total_carrito").innerText = "0.00";
					return;
				}

				for (var i=0;i<lista.length;i++)
				{
					var item = lista[i];
					var div = document.createElement("div");
					div.style.border = "1px solid black";
					div.style.marginBottom = "10px";
					div.style.padding = "5px";

					var imgSrc = item.foto != null ? ("data:image/jpeg;base64," + item.foto) : "/api/Get?nombre=/articulo_sin_foto.png";
					var subtotal = item.precio * item.cantidad;
					total += subtotal;

					div.innerHTML =
						"<img src='" + imgSrc + "' width='60'><br>" +
						"<b>" + item.nombre + "</b><br>" +
						"Precio: $" + item.precio + "<br>" +
						"Cantidad: " + item.cantidad + "<br>" +
						"Subtotal: $" + subtotal.toFixed(2) + "<br>" +
						"<button type='button' style='width:100%;margin-top:5px' onclick='eliminar_articulo_carrito(" + item.id_articulo + ")'>Eliminar artículo</button>";

					cont.appendChild(div);
				}
				get("total_carrito").innerText = total.toFixed(2);
			}

			function eliminar_articulo_carrito(id_articulo)
			{
				if (!confirm("¿Deseas eliminar este artículo del carrito?")) return;
				if (!id_usuario)
				{
					alert("No se ha identificado al usuario (id_usuario nulo). Vuelve a iniciar sesión.");
					return;
				}
				var cliente = new WSClient(URL);
				cliente.delete("elimina_articulo_carrito_compra",
				{
					id_usuario: id_usuario,
					id_articulo: id_articulo,
					token: token
				},
				function(code,result)
				{
					if (code == 200)
					{
						alert("Se eliminó el artículo del carrito");
						mostrar_carrito();
					}
					else
						alert(JSON.stringify(result));
				});
			}

			function eliminar_carrito()
			{
				if (!confirm("¿Deseas eliminar todos los artículos del carrito?")) return;
				if (!id_usuario)
				{
					alert("No se ha identificado al usuario (id_usuario nulo). Vuelve a iniciar sesión.");
					return;
				}
				var cliente = new WSClient(URL);
				cliente.delete("elimina_carrito_compra",
				{
					id_usuario: id_usuario,
					token: token
				},
				function(code,result)
				{
					if (code == 200)
					{
						alert("Se eliminó el carrito de compra");
						mostrar_carrito();
					}
					else
						alert(JSON.stringify(result));
				});
			}

			function seguir_comprando()
			{
				oculta('carrito_compra');
				muestra('compra_articulos');
			}
		</script>
	</head>
	<body>
	<div style="width:250px;margin:auto">

		<!-- ================== ALTA USUARIO ================== -->
		<div id="alta_usuario" style="display:none">
			<h2 style="text-align:center">Registro de usuario</h2>
			Email *<br>
			<input type="email" id="alta_email" value="" style="width:250px"/><br>
			Contraseña *<br>
			<input type="password" id="alta_password" value="" style="width:250px"/><br>
			Nombre *<br>
			<input type="text" id="alta_nombre" value="" style="width:250px"/><br>
			Apellido paterno *<br>
			<input type="text" id="alta_apellido_paterno" value="" style="width:250px"/><br>
			Apellido materno<br>
			<input type="text" id="alta_apellido_materno" value="" style="width:250px"/><br>
			Fecha de nacimiento *<br>
			<input type="datetime-local" id="alta_fecha_nacimiento" value="" style="width:250px"/><br>
			Teléfono<br>
			<input type="number" id="alta_telefono" value="" style="width:250px"/><br>
			Genero<br>
			<select id="alta_genero" style="width:250px">
				<option></option>
				<option>Masculino</option>
				<option>Femenino</option>
			</select>
			<br><br>
			<img id="alta_imagen" width="60px" src="/api/Get?nombre=/usuario_sin_foto.png"></img><br>
			<input type="file" onchange="readSingleFile(files,get('alta_imagen'))" multiple="false" accept="image/*"/><br><br>
			<button type="button" onclick="alta();" style="width:250px;height:40px">Registrar usuario</button><br><br>
			<button type="button" onclick="limpia_login();oculta('alta_usuario');muestra('login')" style="width:250px;height:40px">Cancelar</button><br>
		</div>

		<!-- ================== CONSULTA USUARIO ================== -->
		<div id="consulta_usuario" style="display:none">
			<h2 style="text-align:center">Perfil del usuario</h2>
			Email *<br>
			<input type="email" readonly id="consulta_email" style="width:250px" placeholder="ingresar una nueva contraseña"/><br>
			Contraseña *<br>
			<input type="password" id="consulta_password" value="" style="width:250px"/><br>
			Nombre *<br>
			<input type="text" id="consulta_nombre" value="" style="width:250px"/><br>
			Apellido paterno *<br>
			<input type="text" id="consulta_apellido_paterno" value="" style="width:250px"/><br>
			Apellido materno<br>
			<input type="text" id="consulta_apellido_materno" value="" style="width:250px"/><br>
			Fecha de nacimiento *<br>
			<input type="datetime-local" id="consulta_fecha_nacimiento" value="" style="width:250px"/><br>
			Teléfono<br>
			<input type="number" id="consulta_telefono" value="" style="width:250px"/><br>
			Genero<br>
			<select id="consulta_genero" style="width:250px">
				<option></option>
				<option>Masculino</option>
				<option>Femenino</option>
			</select>
			<br><br>
			<img id="consulta_imagen" width="60px" src="/api/Get?nombre=/usuario_sin_foto.png"></img>
			<input type="file" id="consulta_file" onchange="readSingleFile(files,get('consulta_imagen'))" multiple="false" accept="image/*"/><br>
			<button onclick="quita_foto()">Quitar foto</button><br><br>
			<button type="button" onclick="modifica()" style="width:250px;height:40px">Guardar cambios</button><br><br>
			<button type="button" onclick="oculta('consulta_usuario');muestra('menu')" style="width:250px;height:40px">Regresar</button><br>
		</div>

		<!-- ================== MENÚ PRINCIPAL ================== -->
		<div id="menu" style="display:none">
			<button type="button" onclick="consulta();" style="width:250px;height:40px">Perfil del usuario</button><br><br>
			<button type="button" onclick="muestra_captura_articulo();" style="width:250px;height:40px">Captura de artículo</button><br><br>
			<button type="button" onclick="muestra_compra_articulos();" style="width:250px;height:40px">Compra de artículos</button><br><br>
			<button type="button" onclick="if (confirm('¿Deseas eliminar el perfil del usuario?')){borra();}" style="width:250px;height:40px">Eliminar perfil</button><br><br>
			<button type="button" onclick="limpia_login();oculta('menu');muestra('login')" style="width:250px;height:40px">Salir</button><br>
		</div>

		<!-- ================== LOGIN ================== -->
		<div id="login">
			<h2 style="text-align:center">Acceso al sistema</h2>
			Email<br>
			<input type="email" id="login_email" value="" style="width:250px"/><br><br>
			Password<br>
			<input type="password" id="login_password" value="" style="width:250px"/><br><br>
			<button type="button" onclick="login()" style="width:250px;height:40px">Aceptar</button><br><br>
			<button type="button" onclick="limpia_alta();oculta('login');muestra('alta_usuario')" style="width:250px;height:40px">Registro de usuario</button><br><br>
		</div>

		<!-- ================== CAPTURA ARTÍCULO ================== -->
		<div id="captura_articulo" style="display:none">
			<h2 style="text-align:center">Captura de artículo</h2>
			Nombre *<br>
			<input type="text" id="altaart_nombre" style="width:250px"/><br>
			Descripción *<br>
			<textarea id="altaart_descripcion" style="width:250px;height:60px"></textarea><br>
			Precio *<br>
			<input type="number" step="0.01" id="altaart_precio" style="width:250px"/><br>
			Existencia *<br>
			<input type="number" id="altaart_existencia" style="width:250px"/><br><br>
			<img id="altaart_imagen" width="60px" src="/api/Get?nombre=/articulo_sin_foto.png"></img><br>
			<input type="file" id="altaart_file" onchange="readSingleFileArticulo(files,get('altaart_imagen'))" multiple="false" accept="image/*"/><br><br>
			<button type="button" onclick="guardar_articulo()" style="width:250px;height:40px">Guardar artículo</button><br><br>
			<button type="button" onclick="oculta('captura_articulo');muestra('menu')" style="width:250px;height:40px">Regresar</button><br>
		</div>

		<!-- ================== COMPRA DE ARTÍCULOS ================== -->
		<div id="compra_articulos" style="display:none">
			<h2 style="text-align:center">Compra de artículos</h2>
			Palabra clave<br>
			<input type="text" id="palabra_clave" style="width:250px"/><br><br>
			<button type="button" onclick="buscar_articulos()" style="width:250px;height:40px">Buscar</button><br><br>
			<button type="button" onclick="mostrar_carrito()" style="width:250px;height:40px">Carrito de compra</button><br><br>
			<div id="lista_articulos"></div><br>
			<button type="button" onclick="oculta('compra_articulos');muestra('menu')" style="width:250px;height:40px">Regresar al menú</button><br><br>
		</div>

		<!-- ================== CARRITO DE COMPRA ================== -->
		<div id="carrito_compra" style="display:none">
			<h2 style="text-align:center">Artículos en el carrito</h2>
			<div id="lista_carrito"></div>
			<p><b>Total: $<span id="total_carrito">0.00</span></b></p>
			<button type="button" onclick="eliminar_carrito()" style="width:250px;height:40px">Eliminar carrito</button><br><br>
			<button type="button" onclick="seguir_comprando()" style="width:250px;height:40px">Seguir comprando</button><br><br>
			<button type="button" onclick="oculta('carrito_compra');muestra('menu')" style="width:250px;height:40px">Regresar al menú</button><br>
		</div>

	</div>
	</body>
</html>
